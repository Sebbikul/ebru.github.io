<!DOCTYPE html>
<html lang="no" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0"/>
  <title>L√∏ten-saken</title>
  <style>
    :root {
      --bg: #f8f9fc;
      --card: #ffffff;
      --text: #1f2937;
      --text-light: #4b5563;
      --accent: #dc2626;
      --border: #e5e7eb;
      --shadow: 0 4px 15px rgba(0,0,0,0.06);
    }

    [data-theme="dark"] {
      --bg: #0f172a;
      --card: #1e293b;
      --text: #e2e8f0;
      --text-light: #94a3b8;
      --accent: #f87171;
      --border: #334155;
      --shadow: 0 4px 15px rgba(0,0,0,0.36);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.58;
      min-height: 100dvh;
      overflow-x: hidden;
    }

    .container {
      width: 100%;
      max-width: 820px;
      margin: 0 auto;
      padding: 0 14px;
    }

    header {
      text-align: center;
      padding: 2rem 0 1.8rem;
      position: relative;
    }

    .theme-toggle {
      position: absolute;
      top: 16px;
      right: 16px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: all 0.2s;
      font-size: 1.5rem;
      user-select: none;
      z-index: 10;
    }

    .theme-toggle:hover {
      transform: scale(1.08);
      box-shadow: 0 6px 20px rgba(0,0,0,0.14);
    }

    [data-theme="dark"] .theme-toggle .sun { display: none; }
    [data-theme="light"] .theme-toggle .moon { display: none; }

    h1 {
      font-size: clamp(1.9rem, 5.5vw, 2.3rem);
      margin-bottom: 0.7rem;
      color: var(--accent);
      line-height: 1.15;
    }

    .last-update {
      font-size: 0.94rem;
      color: var(--text-light);
      margin-bottom: 0.5rem;
    }

    .last-update-time {
      color: var(--accent);
      font-weight: 500;
    }

    .credit {
      font-size: 0.87rem;
      color: var(--text-light);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-top: 0.4rem;
    }

    .credit img.avatar {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      object-fit: cover;
    }

    .credit a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 500;
    }

    .credit a:hover {
      text-decoration: underline;
    }

    .bulletin {
      background: var(--card);
      border-radius: 12px;
      padding: 1.4rem 1.5rem;
      margin-bottom: 1.6rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      transition: all 0.18s ease;
      overflow: hidden;
    }

    .bulletin:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 28px rgba(0,0,0,0.1);
    }

    .meta {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 1rem;
      font-size: 0.95rem;
      color: var(--text-light);
      flex-wrap: wrap;
      gap: 0.6rem;
    }

    .author {
      font-weight: 600;
      color: var(--text);
    }

    .time-ago {
      font-size: 0.9rem;
    }

    .title {
      font-size: clamp(1.22rem, 4vw, 1.38rem);
      font-weight: 700;
      margin: 0.4rem 0 1.1rem;
      color: var(--text);
      line-height: 1.28;
    }

    .content {
      font-size: clamp(1.02rem, 3.4vw, 1.08rem);
      color: var(--text);
    }

    .content p {
      margin-bottom: 1.1em;
    }

    .content figure {
      margin: 1.4rem 0;
      text-align: center;
    }

    .content img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 0 auto;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

    .content figcaption {
      font-size: 0.92rem;
      color: var(--text-light);
      margin-top: 0.6rem;
      font-style: italic;
    }

    .qna-thread {
      margin-top: 1.3rem;
      padding-left: 1.2rem;
      border-left: 3px solid var(--accent);
    }

    .qna-item {
      margin: 1.2rem 0;
      padding: 1rem 1.2rem;
      background: rgba(220,38,38,0.03);
      border-radius: 10px;
    }

    .qna-item.question {
      background: rgba(59,130,246,0.06);
      border-left: 4px solid #3b82f6;
    }

    .qna-author {
      font-weight: 600;
      margin-bottom: 0.4rem;
      font-size: 0.97rem;
    }

    .qna-text {
      color: var(--text);
    }

    .loading, .error {
      text-align: center;
      padding: 4rem 1rem;
      color: var(--text-light);
      font-size: 1.12rem;
    }

    @media (max-width: 680px) {
      .container { padding: 0 12px; }
      header { padding: 1.6rem 0 1.4rem; }
      .theme-toggle {
        top: 12px;
        right: 12px;
        width: 42px;
        height: 42px;
        font-size: 1.4rem;
      }
      .bulletin {
        padding: 1.2rem 1.3rem;
        margin-bottom: 1.4rem;
        border-radius: 10px;
      }
      .meta { font-size: 0.92rem; }
    }

    @media (max-width: 480px) {
      h1 { font-size: 1.95rem; }
      .bulletin { padding: 1.1rem 1.2rem; }
      .content { font-size: 1.04rem; }
    }
  </style>
</head>
<body>

<div class="container">
  <header>
    <div class="theme-toggle" id="themeToggle" title="Bytt mellom lys og m√∏rk modus">
      <span class="sun">‚òÄÔ∏è</span>
      <span class="moon">üåô</span>
    </div>
    <h1>Ankesaken etter L√∏ten-drapet</h1>
    <div class="last-update" id="lastUpdate">
      Sist oppdatert: <span class="last-update-time">aldri</span>
    </div>
    <div class="credit">
      Laget av Sebbi 
      <img src="https://cdn.discordapp.com/avatars/469158879029100565/3a8c349cffd41503cf049083c8711239.webp" alt="Sebbi avatar" class="avatar">
      for <a href="https://discord.gg/7a9wqAzcYc" target="_blank" rel="noopener noreferrer">True Crime Norge</a>
    </div>
  </header>

  <div id="feed"></div>

  <div id="loading" class="loading">Laster siste oppdateringer‚Ä¶</div>
  <div id="error" class="error" style="display:none"></div>
</div>

<script>
const BASE_FEED_URL = "https://livecentercdn.norkon.net/BulletinFeed/hamararbeiderblad/79265/EarlierObj/";
const feedDiv   = document.getElementById("feed");
const loading   = document.getElementById("loading");
const errorDiv  = document.getElementById("error");
const lastUpdateEl = document.getElementById("lastUpdate");
const themeToggle = document.getElementById("themeToggle");

let lastIds = "";
let lastBulletins = [];
let bulletinsCache = [];

// Theme handling
function setTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  localStorage.setItem('theme', theme);
}

function updateToggleIcon() {
  const current = document.documentElement.getAttribute('data-theme');
  // Kan utvides om du vil ha flere ikoner
}

const savedTheme = localStorage.getItem('theme');
if (savedTheme) {
  setTheme(savedTheme);
} else {
  setTheme('dark');
}
updateToggleIcon();

themeToggle.addEventListener('click', () => {
  const current = document.documentElement.getAttribute('data-theme');
  const newTheme = current === 'dark' ? 'light' : 'dark';
  setTheme(newTheme);
  updateToggleIcon();
});

function timeAgo(timestamp) {
  const now = Date.now() / 1000;
  const diff = now - timestamp;
  if (diff < 60)    return "akkurat n√•";
  if (diff < 3600)  return Math.floor(diff/60) + " min siden";
  if (diff < 86400) return Math.floor(diff/3600) + " t siden";
  const d = new Date(timestamp * 1000);
  return d.toLocaleDateString("no-NO", {day:"numeric", month:"short", hour:"2-digit", minute:"2-digit"});
}

function updateTimeAgo() {
  document.querySelectorAll('.time-ago').forEach(el => {
    const timestamp = parseInt(el.dataset.timestamp, 10);
    if (!isNaN(timestamp)) {
      el.textContent = timeAgo(timestamp);
    }
  });
}

function renderContent(html) {
  const div = document.createElement("div");
  div.innerHTML = html || "";

  const ncposts = div.querySelectorAll('ncpost-content');
  ncposts.forEach(el => {
    const type = el.getAttribute('data-type');

    if (type === 'BILDE') {
      const src = el.getAttribute('data-src');
      const width = el.getAttribute('data-width');
      const height = el.getAttribute('data-height');
      const caption = el.getAttribute('data-caption') || '';

      if (!src) { el.remove(); return; }

      const figure = document.createElement('figure');
      const img = document.createElement('img');
      img.src = src;
      img.alt = caption;
      img.loading = "lazy";
      img.style.maxWidth = '100%';
      img.style.height = 'auto';
      img.style.display = 'block';
      img.style.margin = '0 auto';

      if (width) img.setAttribute('width', width);
      if (height) img.setAttribute('height', height);

      figure.appendChild(img);
      if (caption.trim()) {
        const figcaption = document.createElement('figcaption');
        figcaption.textContent = caption;
        figure.appendChild(figcaption);
      }
      el.replaceWith(figure);
    }
    else if (type === 'CUSTOM') {
      const temp = document.createElement('textarea');
      temp.innerHTML = el.getAttribute('data-content') || '';
      const decoded = temp.value;

      const parser = new DOMParser();
      const doc = parser.parseFromString(decoded, 'text/html');
      const playerDiv = doc.querySelector('div[data-player-id]');
      const script = doc.querySelector('script');

      if (playerDiv && script && script.src.includes('flowplayer.async.js')) {
        const playerId = playerDiv.getAttribute('data-player-id');
        let config;
        try { config = JSON.parse(script.innerHTML); } catch (e) { console.error('Failed to parse Flowplayer config:', e); }

        if (config && config.src) {
          const videoId = config.src;
          const embedDiv = document.createElement('div');
          embedDiv.className = 'flowplayer-embed-container';
          embedDiv.style.position = 'relative';
          embedDiv.style.paddingBottom = '56.25%';
          embedDiv.style.height = '0';
          embedDiv.style.overflow = 'hidden';
          embedDiv.style.maxWidth = '100%';

          const iframe = document.createElement('iframe');
          iframe.src = `https://ljsp.lwcdn.com/api/video/embed.jsp?id=${videoId}&pi=${playerId}`;
          iframe.title = 'Video';
          iframe.allowFullscreen = true;
          iframe.frameBorder = '0';
          iframe.allow = 'autoplay';
          iframe.style.position = 'absolute';
          iframe.style.top = '0';
          iframe.style.left = '0';
          iframe.style.width = '100%';
          iframe.style.height = '100%';

          embedDiv.appendChild(iframe);
          el.replaceWith(embedDiv);
          return;
        }
      }

      const innerDiv = document.createElement('div');
      innerDiv.innerHTML = decoded;
      el.replaceWith(innerDiv);

      const scripts = innerDiv.querySelectorAll('script');
      scripts.forEach(oldScript => {
        const newScript = document.createElement('script');
        Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
        newScript.appendChild(document.createTextNode(oldScript.innerHTML));
        oldScript.parentNode.replaceChild(newScript, oldScript);
      });
    }
  });

  return div;
}

function renderQna(userContribution = []) {
  if (!userContribution.length) return "";

  const wrapper = document.createElement("div");
  wrapper.className = "qna-thread";

  userContribution.forEach(item => {
    const el = document.createElement("div");
    el.className = `qna-item ${item.commentType?.toLowerCase() === "question" ? "question" : ""}`;
    el.innerHTML = `
      <div class="qna-author">${item.name || "Anonym"} ${item.commentType === "Question" ? "spurte:" : "kommenterte:"}</div>
      <div class="qna-text">${item.comment || ""}</div>
    `;
    wrapper.appendChild(el);

    if (item.childComments?.length) {
      const sub = renderQna(item.childComments);
      if (sub) wrapper.appendChild(sub);
    }
  });

  return wrapper;
}

async function fetchAllBulletins() {
  let allBulletins = [];
  let nextId = 0;
  while (true) {
    const url = `${BASE_FEED_URL}${nextId}`;
    try {
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) break;
      const data = await r.json();
      if (!data?.success || !data?.result?.bulletins) break;
      allBulletins.push(...data.result.bulletins);
      if (!data.result.hasMore) break;
      nextId = data.result.bulletins[data.result.bulletins.length - 1].id;
    } catch (err) {
      console.error(err);
      break;
    }
  }
  return allBulletins;
}

async function render() {
  const checkTime = new Date().toLocaleTimeString("no-NO");

  try {
    const bulletins = await fetchAllBulletins();
    bulletins.sort((a, b) => b.created - a.created);

    const ids = bulletins.map(b => b.id).join(",");
    const hasNewData = ids !== lastIds;

    lastIds = ids;
    bulletinsCache = bulletins;

    const scrollY = window.scrollY;

    loading.style.display = "none";
    errorDiv.style.display = "none";

    // Alltid oppdater "Sist oppdatert"
    lastUpdateEl.innerHTML = `Sist oppdatert: <span class="last-update-time">${checkTime}</span> (sjekkes hvert 30. sekund)`;

    // Hvis nye data ‚Üí bygg om hele feed
    if (hasNewData) {
      feedDiv.innerHTML = "";

      bulletins.forEach(b => {
        const card = document.createElement("article");
        card.className = "bulletin";

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.innerHTML = `
          <span class="author">${b.authorName || "Ukjent"}</span>
          <span class="time-ago" data-timestamp="${b.created}">${timeAgo(b.created)}</span>
        `;

        let titleEl = "";
        if (b.title) titleEl = `<h2 class="title">${b.title}</h2>`;

        const contentDiv = renderContent(b.content?.html);

        card.appendChild(meta);
        if (titleEl) card.insertAdjacentHTML("beforeend", titleEl);
        card.appendChild(contentDiv);

        if (b.content?.userContribution?.length) {
          const qna = renderQna(b.content.userContribution);
          if (qna) card.appendChild(qna);
        }

        feedDiv.appendChild(card);
      });

      window.scrollTo(0, scrollY);
    }

    // Uansett ‚Üí oppdater alle tidsstempler
    updateTimeAgo();

  } catch (err) {
    console.error(err);
    errorDiv.textContent = "Kunne ikke laste oppdateringer ‚Äì pr√∏ver igjen om 30 sek";
    errorDiv.style.display = "block";

    lastUpdateEl.innerHTML = `Sist sjekket: <span class="last-update-time">${checkTime}</span> (feilet)`;
    updateTimeAgo(); // oppdater likevel tidene vi har
  }
}

render();
setInterval(() => {
  render();
  // Ekstra kall for √• sikre at tidene oppdateres selv ved feil i fetch
  updateTimeAgo();
}, 30000);

// Kj√∏r updateTimeAgo hyppigere (f.eks. hvert 20. sekund) for √• holde "akkurat n√•" / minutter presist
setInterval(updateTimeAgo, 20000);
</script>
</body>
</html>
