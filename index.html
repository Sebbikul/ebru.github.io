<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ebru-saken – Live oppdateringer</title>
    <style>
        :root {
            --primary: #c8102e;
            --dark: #1a1a1a;
            --light: #f8f9fa;
            --gray: #6c757d;
            --border: #dee2e6;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--light);
            color: var(--dark);
            margin: 0;
            padding: 16px;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 1.5rem 0 2rem;
            border-bottom: 2px solid var(--primary);
            margin-bottom: 2rem;
        }

        h1 {
            color: var(--primary);
            margin: 0;
            font-size: 2.1rem;
        }

        .subtitle {
            color: var(--gray);
            margin-top: 0.5rem;
            font-size: 1.1rem;
        }

        .post {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 1.6rem;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: transform 0.08s ease, box-shadow 0.15s ease;
        }

        .post:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

        .post-header {
            padding: 1.2rem 1.4rem;
            background: linear-gradient(to right, #f8f9fa, white);
            border-bottom: 1px solid var(--border);
        }

        .post-title {
            margin: 0 0 0.6rem 0;
            font-size: 1.35rem;
            color: var(--dark);
        }

        .meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.92rem;
            color: var(--gray);
        }

        .author {
            font-weight: 600;
            color: #444;
        }

        .timestamp {
            font-size: 0.88rem;
        }

        .post-body {
            padding: 1.4rem;
        }

        .post-body:empty {
            display: none;
        }

        .post-body p {
            margin: 0 0 1rem 0;
        }

        .post-body img {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            margin: 1.2rem 0;
            box-shadow: 0 3px 10px rgba(0,0,0,0.12);
            display: block;
        }

        .user-contributions {
            margin-top: 1.8rem;
            padding: 1.2rem 1.4rem;
            border-top: 1px dashed #e0e0e0;
            background: #fafafa;
        }

        .user-contributions h3 {
            margin: 0 0 1rem 0;
            font-size: 1.15rem;
            color: var(--dark);
        }

        .contrib {
            padding: 1rem;
            margin: 0.6rem 0;
            background: white;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        .contrib-name {
            font-weight: 700;
            color: var(--primary);
            margin-right: 0.4rem;
        }

        .loading, .error, .loading-more {
            text-align: center;
            padding: 2rem 1rem;
            font-size: 1.1rem;
            color: var(--gray);
        }

        .error {
            color: #dc3545;
        }

        @media (max-width: 600px) {
            .post-header, .post-body, .user-contributions {
                padding: 1.1rem;
            }
            h1 { font-size: 1.8rem; }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Ebru-saken</h1>
            <div class="subtitle">Siste nytt fra rettssalen – ankebehandling drapet på Ole Andreas Sønstvedt</div>
        </header>

        <div id="loading" class="loading">Laster siste oppdateringer...</div>
        <div id="error" class="error" style="display:none;"></div>
        <div id="feed"></div>
        <div id="loading-more" class="loading-more" style="display:none;">Laster eldre meldinger...</div>
    </div>

    <script>
        const BASE_URL = 'https://livecentercdn.norkon.net/BulletinFeed/hamararbeiderblad/79265/';
        const INITIAL_ENDPOINT = 'Initial';
        const feed = document.getElementById('feed');
        const loading = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const loadingMore = document.getElementById('loading-more');

        let allPosts = [];
        let lastTs = 0;
        let oldestId = null;
        let isLoadingMore = false;

        async function fetchJson(url) {
            const res = await fetch(url);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return res.json();
        }

        async function loadInitialAndPoll() {
            try {
                const data = await fetchJson(BASE_URL + INITIAL_ENDPOINT);

                if (!data.success || !data.result?.addedOrChanged) {
                    throw new Error('Ugyldig respons fra Initial');
                }

                const ts = data.result.ts || 0;
                if (ts > lastTs) {
                    lastTs = ts;

                    const newPosts = data.result.addedOrChanged || [];
                    if (newPosts.length > 0) {
                        // Oppdater oldestId hvis dette er første lasting eller vi har flere
                        const currentOldest = Math.min(...newPosts.map(p => p.id));
                        if (!oldestId || currentOldest < oldestId) {
                            oldestId = currentOldest;
                        }

                        // Legg til nye poster (unngå duplikater basert på id)
                        newPosts.forEach(post => {
                            if (!allPosts.some(p => p.id === post.id)) {
                                allPosts.push(post);
                            }
                        });

                        renderAllPosts();
                    }
                }

                loading.style.display = 'none';
                errorDiv.style.display = 'none';

                // Hvis hasMore eller vi mistenker flere sider → last inn eldre én gang ved start
                if ((data.result.hasMore || allPosts.length < 20) && !isLoadingMore && oldestId) {
                    loadEarlier(oldestId);
                }

            } catch (err) {
                errorDiv.textContent = `Feil ved lasting: ${err.message}`;
                errorDiv.style.display = 'block';
                loading.style.display = 'none';
            }
        }

        async function loadEarlier(minId) {
            if (isLoadingMore) return;
            isLoadingMore = true;
            loadingMore.style.display = 'block';

            try {
                const url = `${BASE_URL}EarlierObj/${minId}`;
                const data = await fetchJson(url);

                if (!data.success || !data.result?.bulletins) {
                    console.warn('Ingen flere eldre meldinger eller ugyldig format');
                    return;
                }

                const olderPosts = data.result.bulletins || [];

                olderPosts.forEach(post => {
                    if (!allPosts.some(p => p.id === post.id)) {
                        allPosts.push(post);
                    }
                });

                // Oppdater oldestId til den eldste i denne batchen
                if (olderPosts.length > 0) {
                    const newOldest = Math.min(...olderPosts.map(p => p.id));
                    if (newOldest < minId) {
                        oldestId = newOldest;
                        // Hvis hasMore fortsatt sant → kunne lastet mer, men vi stopper her for nå
                    }
                }

                renderAllPosts();

            } catch (err) {
                console.error('Feil ved lasting av eldre:', err);
            } finally {
                isLoadingMore = false;
                loadingMore.style.display = 'none';
            }
        }

        function renderAllPosts() {
            // Sorter nyest → eldst
            const sorted = [...allPosts].sort((a, b) => b.created - a.created);

            feed.innerHTML = '';

            sorted.forEach(post => {
                const el = document.createElement('article');
                el.className = 'post';

                let headerHTML = `
                    <div class="post-header">
                        ${post.title ? `<h2 class="post-title">${post.title}</h2>` : ''}
                        <div class="meta">
                            <span class="author">${post.authorName || 'Ukjent'}</span>
                            <span class="timestamp">${formatDate(post.created)}</span>
                        </div>
                    </div>
                `;

                let bodyHTML = '';
                if (post.content?.html && post.content.html.trim() !== '') {
                    let cleaned = post.content.html.replace(
                        /<ncpost-content\s+data-type="BILDE"\s+data-src="([^"]+)"[^>]*>/gi,
                        (m, src) => `<img src="${src}" alt="Bilde fra saken" loading="lazy">`
                    );
                    cleaned = cleaned.replace(/<ncpost-content[^>]*><\/ncpost-content>/gi, '');

                    bodyHTML = `<div class="post-body">${cleaned}</div>`;
                }

                let contribHTML = '';
                const contributions = post.content?.userContribution || [];
                if (contributions.length > 0) {
                    contribHTML = `<div class="user-contributions"><h3>Spørsmål & kommentarer</h3>`;
                    contributions.forEach(c => {
                        contribHTML += renderContribution(c, 0);
                    });
                    contribHTML += '</div>';
                }

                el.innerHTML = headerHTML + bodyHTML + contribHTML;

                if (headerHTML.trim() || bodyHTML || contribHTML) {
                    feed.appendChild(el);
                }
            });
        }

        function renderContribution(c, level) {
            let html = `
                <div class="contrib" style="margin-left: ${level * 24}px;">
                    <span class="contrib-name">${c.name || 'Anonym'}:</span>
                    <span>${c.comment || '(ingen tekst)'}</span>
                </div>
            `;
            if (c.childComments?.length) {
                c.childComments.forEach(child => {
                    html += renderContribution(child, level + 1);
                });
            }
            return html;
        }

        function formatDate(unix) {
            if (!unix) return '—';
            const d = new Date(unix * 1000);
            return d.toLocaleString('no-NO', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            }).replace(',', '');
        }

        // Start lasting
        loadInitialAndPoll();

        // Polling for nye meldinger (kun Initial)
        setInterval(loadInitialAndPoll, 25000);

        // Valgfritt: last flere eldre ved scroll (laster én gang til ved start nå)
        window.addEventListener('scroll', () => {
            if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 800 &&
                oldestId && !isLoadingMore) {
                loadEarlier(oldestId);
            }
        });
    </script>
</body>
</html>
